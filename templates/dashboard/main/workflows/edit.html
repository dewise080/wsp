{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}{{ title }} - {{ seo_settings.meta_title }}{% endblock title %}
{% block content %}
<div class="page-body">
   <div class="container-fluid">
      <div class="page-title">
         <div class="row">
            <div class="col-6">
               <h3>Edit Workflow</h3>
            </div>
            <div class="col-6">
               <ol class="breadcrumb">
                  <li class="breadcrumb-item">
                     <a href="{% url 'adminHome' %}">
                        <svg class="stroke-icon">
                           <use href="{% static 'admin/assets/svg/icon-sprite.svg' %}#stroke-home"></use>
                        </svg>
                     </a>
                  </li>
                  <li class="breadcrumb-item"><a href="{% url 'adminWorkflowList' %}">Workflows</a></li>
                  <li class="breadcrumb-item active">Edit</li>
               </ol>
            </div>
         </div>
      </div>
   </div>
   <!-- Container-fluid starts-->
   <div class="container-fluid">
      <div class="row project-cards">
         <div class="col-md-12 project-list">
         </div>
         <div class="container">
            <form method="POST" enctype="multipart/form-data">
               {% csrf_token %}
               {% if form.errors %}
               <div class="alert alert-danger">
                  <strong>Error:</strong>
                  <ul>
                     {% for field, errors in form.errors.items %}
                     {% for error in errors %}
                     <li>{{ field }}: {{ error }}</li>
                     {% endfor %}
                     {% endfor %}
                  </ul>
               </div>
               {% endif %}                   
               <div class="row mb-3">
                  <div class="col-md-8">
                     <div class="card">
                        <div class="card-body">
                           <label for="{{ form.name.id_for_label }}" class="form-label">Workflow Name <span class="text-danger">*</span></label>
                           {{ form.name }}
                        </div>
                     </div>
                  </div>
                  <div class="col-md-4">
                     <div class="card">
                        <div class="card-body">
                           <label class="form-label">Status</label>
                           <div class="form-check form-switch mt-2">
                              {{ form.is_active }}
                              <label class="form-check-label" for="{{ form.is_active.id_for_label }}">Active</label>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="row mb-3">
                  <div class="col-md-12">
                     <div class="card">
                        <div class="card-body">
                           <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                           {{ form.description }}
                        </div>
                     </div>
                  </div>
               </div>
               <div class="row mb-3">
                  <div class="col-md-12">
                     <div class="card">
                        <div class="card-header">
                           <h5>Workflow Statistics</h5>
                        </div>
                        <div class="card-body">
                           <div class="row">
                              <div class="col-md-3">
                                 <div class="text-center">
                                    <h4 class="text-primary">{{ workflow.nodes.count }}</h4>
                                    <p class="text-muted">Nodes</p>
                                 </div>
                              </div>
                              <div class="col-md-3">
                                 <div class="text-center">
                                    <h4 class="text-info">{{ workflow.edges.count }}</h4>
                                    <p class="text-muted">Connections</p>
                                 </div>
                              </div>
                              <div class="col-md-3">
                                 <div class="text-center">
                                    <h4 class="text-success">{{ workflow.created_at|date:"M d, Y" }}</h4>
                                    <p class="text-muted">Created</p>
                                 </div>
                              </div>
                              <div class="col-md-3">
                                 <div class="text-center">
                                    <h4 class="text-warning">{{ workflow.updated_at|date:"M d, Y" }}</h4>
                                    <p class="text-muted">Last Updated</p>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               
               <!-- Import/Export Section -->
               <div class="row mb-3">
                  <div class="col-md-6">
                     <div class="card">
                        <div class="card-header">
                           <h5><i class="icon-upload"></i> Import JSON</h5>
                        </div>
                        <div class="card-body">
                           <p class="text-muted mb-3">Upload a JSON file to replace the current workflow nodes and edges.</p>
                           <input type="file" id="json-file-input" accept=".json" class="form-control mb-2">
                           <button type="button" id="btn-import-json" class="btn btn-warning btn-sm">
                              <i class="icon-upload"></i> Import from JSON
                           </button>
                           <div id="import-status" class="mt-2"></div>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <div class="card">
                        <div class="card-header">
                           <h5><i class="icon-download"></i> Export JSON</h5>
                        </div>
                        <div class="card-body">
                           <p class="text-muted mb-3">Download the current workflow as a JSON file.</p>
                           <button type="button" id="btn-export-json" class="btn btn-success btn-sm">
                              <i class="icon-download"></i> Export to JSON
                           </button>
                        </div>
                     </div>
                  </div>
               </div>
               
               <div class="row mb-3">
                  <div class="col-md-12">
                     <button type="submit" class="btn btn-primary">Save Changes</button>
                     <a href="{% url 'adminWorkflowModifier' workflow.slug %}" class="btn btn-info">Open Visual Editor</a>
                     <a href="{% url 'adminWorkflowList' %}" class="btn btn-secondary">Cancel</a>
                  </div>
               </div>
            </form>
         </div>
      </div>
   </div>
</div>

<!-- Hidden data for export -->
<script id="workflow-data" type="application/json">{{ flow_data|safe }}</script>
<script id="workflow-slug" type="text/plain">{{ workflow.slug }}</script>
<script id="import-url" type="text/plain">{% url 'adminWorkflowUploadJson' workflow.slug %}</script>
<script id="csrf-token" type="text/plain">{{ csrf_token }}</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Export JSON
    document.getElementById('btn-export-json').addEventListener('click', function() {
        const data = document.getElementById('workflow-data').textContent;
        const slug = document.getElementById('workflow-slug').textContent;
        const blob = new Blob([data], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = slug + '-workflow.json';
        a.click();
        URL.revokeObjectURL(a.href);
    });
    
    // Import JSON
    document.getElementById('btn-import-json').addEventListener('click', async function() {
        const fileInput = document.getElementById('json-file-input');
        const statusDiv = document.getElementById('import-status');
        
        if (!fileInput.files.length) {
            statusDiv.innerHTML = '<div class="alert alert-warning">Please select a JSON file first.</div>';
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const jsonData = JSON.parse(e.target.result);
                
                // Validate JSON structure
                if (!jsonData.nodes || !Array.isArray(jsonData.nodes)) {
                    throw new Error('Invalid JSON: missing "nodes" array');
                }
                if (!jsonData.edges || !Array.isArray(jsonData.edges)) {
                    throw new Error('Invalid JSON: missing "edges" array');
                }
                
                const importUrl = document.getElementById('import-url').textContent;
                const csrfToken = document.getElementById('csrf-token').textContent;
                
                const response = await fetch(importUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(jsonData),
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    statusDiv.innerHTML = '<div class="alert alert-success">Workflow imported successfully! Reloading...</div>';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error(result.error || 'Failed to import');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        };
        
        reader.readAsText(file);
    });
});
</script>
{% endblock content %}
