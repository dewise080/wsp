{% load static %}
<script src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
<script src="{% static 'ckeditor/ckeditor-init.js' %}"></script>
{% if request.user.is_authenticated %}
<div id="inline-edit-toolbar" style="position:fixed;bottom:16px;right:16px;z-index:9999;background:#111827;color:#e5e7eb;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.25);display:flex;gap:10px;align-items:center;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;">
  <button id="toggle-inline-edit" style="background:#10b981;color:#fff;border:none;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer;">Enable inline edit</button>
  <span id="inline-edit-status" style="font-size:12px;color:#9ca3af;">Toggle to edit elements with <code>data-inline-field</code>.</span>
</div>
<script>
  (function() {
    const btn = document.getElementById('toggle-inline-edit');
    const status = document.getElementById('inline-edit-status');
    let enabled = false;

    function getCsrfToken() {
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : '';
    }

    function setEditable(on) {
      document.querySelectorAll('[data-inline-field]').forEach(el => {
        el.contentEditable = on;
        el.dataset.inlineActive = on ? '1' : '';
        el.style.outline = on ? '2px dashed #10b981' : '';
        if (on && el.dataset.inlineRich === 'true' && window.CKEDITOR && !CKEDITOR.instances[el.id || '']) {
          const editorId = el.id || `inline-${Date.now()}-${Math.random().toString(16).slice(2)}`;
          el.id = editorId;
          CKEDITOR.inline(editorId);
        }
        if (!on && window.CKEDITOR && el.id && CKEDITOR.instances[el.id]) {
          CKEDITOR.instances[el.id].destroy();
        }
        if (on) {
          el.addEventListener('blur', handleSave);
        } else {
          el.removeEventListener('blur', handleSave);
        }
      });
    }

    async function handleSave(e) {
      const el = e.currentTarget;
      const api = el.dataset.inlineApi;
      const field = el.dataset.inlineField;
      const id = el.dataset.inlineId;
      if (!api || !field || !id) return;
      let value = el.innerHTML;
      if (window.CKEDITOR && el.id && CKEDITOR.instances[el.id]) {
        value = CKEDITOR.instances[el.id].getData();
      }
      try {
        const res = await fetch(`${api}?id=${encodeURIComponent(id)}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
          },
          body: JSON.stringify({ [field]: value }),
        });
        if (!res.ok) throw new Error(`Save failed (${res.status})`);
        status.textContent = 'Saved';
        status.style.color = '#10b981';
        setTimeout(() => { status.textContent = 'Edit mode active'; status.style.color = '#9ca3af'; }, 1500);
      } catch (err) {
        status.textContent = err.message;
        status.style.color = '#ef4444';
      }
    }

    btn.addEventListener('click', () => {
      enabled = !enabled;
      setEditable(enabled);
      btn.textContent = enabled ? 'Disable inline edit' : 'Enable inline edit';
      status.textContent = enabled ? 'Edit mode active' : 'Edit mode off';
      status.style.color = '#9ca3af';
    });
  })();
</script>
{% endif %}
